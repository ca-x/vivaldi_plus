name: build

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          [
            { name: windows_x86, arch: x86 },
            { name: windows_x64, arch: x64 },
            { name: windows_arm64, arch: arm64 }
          ]

    name: ${{ matrix.name }}

    runs-on: windows-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          submodules: "true"

      - name: setup VC-LTL
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: nuget install VC-LTL

      - name: setup xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: configure
        run: xmake f -a ${{ matrix.arch }} -m release -y

      - name: build
        run: xmake

      - name: package
        run: |
          mkdir -p package
          cp build/release/${{ matrix.arch }}/version.dll package/
          cp config.ini.example package/
          cp config.ini.example.zh-CN package/
          cd package
          7z a ../${{ matrix.name }}.zip *

      - name: upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.zip

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Prepare release files
        run: |
          ls -R dist/
          mkdir -p release/
          find dist/ -name "*.zip" -exec cp {} release/ \;
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: true
          generate_release_notes: true
          name: Release ${{ github.ref_name }}
          body: |
            ## Vivaldi++ ${{ github.ref_name }}

            ### ä¸‹è½½ / Download
            - **windows_x64.zip** - 64ä½ç‰ˆæœ¬ (æ¨è / Recommended)
            - **windows_arm64.zip** - ARM64ç‰ˆæœ¬ (Windows on ARM è®¾å¤‡ / Windows on ARM devices)
            - **windows_x86.zip** - 32ä½ç‰ˆæœ¬

            ### æ¶æ„è¯´æ˜ / Architecture Notes
            - **x64**: é€‚ç”¨äºç°ä»£ 64 ä½ Windows ç³»ç»Ÿ / For modern 64-bit Windows systems
            - **ARM64**: é€‚ç”¨äº Windows on ARM è®¾å¤‡ï¼ˆå¦‚ Surface Pro Xã€Snapdragon ç¬”è®°æœ¬ï¼‰ / For Windows on ARM devices (Surface Pro X, Snapdragon laptops)
            - **x86**: é€‚ç”¨äºä¼ ç»Ÿ 32 ä½ Windows ç³»ç»Ÿ / For legacy 32-bit Windows systems

            ### æŠ€æœ¯æ›´æ–° / Technical Updates
            - ğŸ”„ **è¿ç§»åˆ° Microsoft Detours** - ä» MinHook è¿ç§»ä»¥æ”¯æŒ ARM64 / Migrated from MinHook for ARM64 support
            - âœ… **ARM64 æ”¯æŒ** - å®Œæ•´æ”¯æŒ Windows on ARM è®¾å¤‡ / Full Windows on ARM support

            ### ä½¿ç”¨æ–¹æ³• / Usage
            1. æ ¹æ®ä½ çš„ç³»ç»Ÿæ¶æ„é€‰æ‹©å¯¹åº”çš„zipæ–‡ä»¶ / Choose the zip file for your system architecture
            2. è§£å‹ä¸‹è½½çš„zipæ–‡ä»¶ / Extract the downloaded zip file
            3. å°† `version.dll` å¤åˆ¶åˆ° Vivaldi å®‰è£…ç›®å½• / Copy `version.dll` to Vivaldi installation directory
            4. ï¼ˆå¯é€‰ï¼‰å¤åˆ¶ `config.ini.example` ä¸º `config.ini` å¹¶æ ¹æ®éœ€è¦é…ç½® / (Optional) Copy `config.ini.example` to `config.ini` and configure
            5. å¯åŠ¨ Vivaldi / Start Vivaldi

            ### åŠŸèƒ½ç‰¹æ€§ / Features
            - âœ… è€æ¿é”®æ”¯æŒ - ä¸€é”®éšè—çª—å£å’Œé™éŸ³ / Boss Key - Hide windows and mute audio with hotkey
            - âœ… ä¾¿æºæ¨¡å¼ - æ•°æ®ä¸ç¨‹åºåˆ†ç¦» / Portable mode - Data and app separation
            - âœ… å¯†ç ä¾¿æºåŒ– - è·¨æœºå™¨ä½¿ç”¨ / Password portability - Cross-machine usage

            ### é…ç½®è€æ¿é”® / Configure Boss Key
            åœ¨ `config.ini` ä¸­æ·»åŠ ï¼š/ Add to `config.ini`:
            ```ini
            [hotkey]
            boss_key=Ctrl+Alt+B
            ```

            ---
            å®Œæ•´æ›´æ–°æ—¥å¿—è§ä¸‹æ–¹ / Full changelog below
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
